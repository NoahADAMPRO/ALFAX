<!DOCTYPE html>
<html lang="fr" class="{{ db.config.theme }}">
<head>
    <meta charset="UTF-8">
    <title>Connexion | {{ db.config.logo }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script> tailwind.config = { darkMode: 'class' } </script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style> body { font-family: 'Poppins', sans-serif; } </style>
</head>
<body class="h-screen w-screen flex items-center justify-center bg-white dark:bg-gray-900 transition-colors duration-500 overflow-hidden">
    
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-[10%] left-[5%] w-64 h-64 bg-blue-50 rounded-full blur-3xl dark:bg-blue-900/10"></div>
        <div class="absolute bottom-[10%] right-[5%] w-64 h-64 bg-gray-50 rounded-full blur-3xl dark:bg-gray-800/20"></div>
    </div>

    <div class="w-full max-w-md p-6 relative z-10 text-center">
        <h1 class="text-5xl font-black text-black dark:text-white mb-10 tracking-tighter">{{ db.config.logo }}</h1>
        
        <form id="loginForm" method="POST" class="bg-white dark:bg-gray-800 p-10 rounded-[3rem] shadow-[0_20px_50px_rgba(0,0,0,0.05)] border border-gray-100 dark:border-gray-700">
            {% if error %}<p class="mb-4 text-red-500 text-sm font-bold">{{ error }}</p>{% endif %}

            <div class="space-y-6 text-left">
                <div>
                    <label class="text-[11px] font-black uppercase text-gray-400 ml-2 tracking-wider">Email ou Identifiant</label>
                    <input type="text" name="identifier" id="ident" required class="w-full p-4 mt-2 bg-gray-50 dark:bg-gray-900 rounded-2xl border-2 border-transparent focus:border-black dark:focus:border-blue-500 outline-none transition-all dark:text-white" placeholder="admin@alfax.os">
                </div>
                <div>
                    <label class="text-[11px] font-black uppercase text-gray-400 ml-2 tracking-wider">Mot de passe</label>
                    <input type="password" name="password" id="pass" required class="w-full p-4 mt-2 bg-gray-50 dark:bg-gray-900 rounded-2xl border-2 border-transparent focus:border-black dark:focus:border-blue-500 outline-none transition-all dark:text-white" placeholder="••••••••">
                </div>
                <button type="submit" class="w-full py-4 bg-black dark:bg-blue-600 text-white font-black rounded-2xl hover:scale-[1.02] transition-all shadow-xl shadow-black/5">ENTRER</button>
            </div>
        </form>
    </div>

    <div id="securityModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-md hidden">
        <div class="bg-white dark:bg-gray-800 p-10 rounded-[2.5rem] w-full max-w-sm text-center shadow-2xl scale-95 transition-transform duration-300">
            <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
            </div>
            <h2 class="text-2xl font-black mb-2 dark:text-white">Sécurité</h2>
            <p id="questionText" class="text-gray-500 dark:text-gray-400 text-sm mb-6"></p>
            
            <form action="/login_step2" method="POST" class="space-y-4">
                <input type="hidden" name="identifier" id="hiddenIdent">
                <input type="text" name="security_answer" required autofocus class="w-full p-4 bg-gray-50 dark:bg-gray-900 rounded-2xl border-2 border-transparent focus:border-blue-500 outline-none dark:text-white" placeholder="Votre réponse">
                <button type="submit" class="w-full py-4 bg-blue-600 text-white font-black rounded-2xl hover:bg-blue-700 transition-all">VÉRIFIER</button>
            </form>
        </div>
    </div>

    <script>
        // Gestion de l'étape 1 via AJAX pour afficher la modale
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const response = await fetch('/login_step1', { method: 'POST', body: formData });
            const result = await response.json();

            if (result.status === 'success') {
                if (result.question) {
                    // On affiche la modale avec la question
                    document.getElementById('questionText').innerText = result.question;
                    document.getElementById('hiddenIdent').value = document.getElementById('ident').value;
                    document.getElementById('securityModal').classList.remove('hidden');
                } else {
                    // Pas de question, on redirige vers l'index
                    window.location.href = '/';
                }
            } else {
                alert(result.message || "Identifiants incorrects");
            }
        };
    </script>
</body>
</html>
